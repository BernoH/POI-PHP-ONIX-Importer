<?php

class BookGluttonONIXTagExpander
{
	/*
	
		Expands short tags to long, optionally
	
	*/
	
	public function __construct($xml=null)
	{
		
		$this->xml= $xml;
		$this->xsl = null;
		$this->transformed = null;
		$this->productTagMap = array(
		'ONIXmessage'=>'ONIXMessage',
		'b276'=>'AbbreviatedLength',
		'm380'=>'AddresseeIDType',
		'addresseeidentifier'=>'AddresseeIdentifier',
		'b046'=>'Affiliation',
		'j400'=>'AgentIDType',
		'agentidentifier'=>'AgentIdentifier',
		'j401'=>'AgentName',
		'j402'=>'AgentRole',
		'h133'=>'AlternativeFormatEAN13',
		'h132'=>'AlternativeFormatISBN',
		'h164'=>'AlternativeProductEAN13',
		'h163'=>'AlternativeProductISBN',
		'd100'=>'Annotation',
		'b086'=>'AnnouncementDate',
		'audience'=>'Audience',
		'b073'=>'AudienceCode',
		'b204'=>'AudienceCodeType',
		'b205'=>'AudienceCodeTypeName',
		'b206'=>'AudienceCodeValue',
		'b207'=>'AudienceDescription',
		'audiencerange'=>'AudienceRange',
		'b075'=>'AudienceRangePrecision',
		'b074'=>'AudienceRangeQualifier',
		'b076'=>'AudienceRangeValue',
		'j146'=>'AudienceRestrictionFlag',
		'j147'=>'AudienceRestrictionNote',
		'j141'=>'AvailabilityCode',
		'b064'=>'BASICMainSubject',
		'b200'=>'BASICVersion',
		'j150'=>'BICDiscountGroupCode',
		'b065'=>'BICMainSubject',
		'b066'=>'BICVersion',
		'b246'=>'Barcode',
		'batchbonus'=>'BatchBonus',
		'j264'=>'BatchQuantity',
		'bible'=>'Bible',
		'b352'=>'BibleContents',
		'b354'=>'BiblePurpose',
		'b356'=>'BibleReferenceLocation',
		'b357'=>'BibleTextFeature',
		'b355'=>'BibleTextOrganization',
		'b353'=>'BibleVersion',
		'b044'=>'BiographicalNote',
		'k169'=>'BookClubAdoption',
		'b013'=>'BookFormDetail',
		'j375'=>'CBO',
		'b209'=>'CityOfPublication',
		'j149'=>'ClassOfTrade',
		'complexity'=>'Complexity',
		'b078'=>'ComplexityCode',
		'b077'=>'ComplexitySchemeIdentifier',
		'b289'=>'ComponentNumber',
		'b288'=>'ComponentTypeName',
		'conference'=>'Conference',
		'b341'=>'ConferenceAcronym',
		'b054'=>'ConferenceDate',
		'b050'=>'ConferenceDescription',
		'b052'=>'ConferenceName',
		'b053'=>'ConferenceNumber',
		'b055'=>'ConferencePlace',
		'b051'=>'ConferenceRole',
		'conferencesponsor'=>'ConferenceSponsor',
		'b391'=>'ConferenceSponsorIDType',
		'conferencesponsoridentifier'=>'ConferenceSponsorIdentifier',
		'b342'=>'ConferenceTheme',
		'containeditem'=>'ContainedItem',
		'contentitem'=>'ContentItem',
		'contributor'=>'Contributor',
		'b048'=>'ContributorDescription',
		'b035'=>'ContributorRole',
		'b049'=>'ContributorStatement',
		'k168'=>'CopiesSold',
		'b084'=>'CopublisherName',
		'copyrightowner'=>'CopyrightOwner',
		'b392'=>'CopyrightOwnerIDType',
		'copyrightowneridentifier'=>'CopyrightOwnerIdentifier',
		'copyrightstatement'=>'CopyrightStatement',
		'b087'=>'CopyrightYear',
		'b071'=>'CorporateBodyAsSubject',
		'b047'=>'CorporateName',
		'b251'=>'CountryCode',
		'j304'=>'CountryExcluded',
		'b083'=>'CountryOfPublication',
		'f111'=>'CoverImageFormatCode',
		'f113'=>'CoverImageLink',
		'f112'=>'CoverImageLinkTypeCode',
		'j152'=>'CurrencyCode',
		'b009'=>'DOI',
		'b306'=>'Date',
		'j260'=>'DateFormat',
		'm193'=>'DefaultClassOfTrade',
		'm186'=>'DefaultCurrencyCode',
		'm184'=>'DefaultLanguageOfText',
		'm187'=>'DefaultLinearUnit',
		'm185'=>'DefaultPriceTypeCode',
		'm188'=>'DefaultWeightUnit',
		'a198'=>'DeletionCode',
		'a199'=>'DeletionText',
		'c258'=>'Dimensions',
		'j364'=>'DiscountCode',
		'j363'=>'DiscountCodeType',
		'j378'=>'DiscountCodeTypeName',
		'discountcoded'=>'DiscountCoded',
		'j267'=>'DiscountPercent',
		'b028'=>'DistinctiveTitle',
		'f119'=>'DownloadCaption',
		'f121'=>'DownloadCopyrightNotice',
		'f120'=>'DownloadCredit',
		'f122'=>'DownloadTerms',
		'b005'=>'EAN13',
		'b022'=>'EAN13OfSet',
		'b057'=>'EditionNumber',
		'b058'=>'EditionStatement',
		'b056'=>'EditionTypeCode',
		'b217'=>'EditionVersionNumber',
		'j272'=>'EmailAddress',
		'b325'=>'EndDate',
		'b214'=>'EpubFormat',
		'b216'=>'EpubFormatDescription',
		'b215'=>'EpubFormatVersion',
		'b278'=>'EpubSource',
		'b280'=>'EpubSourceDescription',
		'b279'=>'EpubSourceVersion',
		'b211'=>'EpubType',
		'b213'=>'EpubTypeDescription',
		'b277'=>'EpubTypeNote',
		'b212'=>'EpubTypeVersion',
		'j302'=>'ExpectedDate',
		'j142'=>'ExpectedShipDate',
		'extent'=>'Extent',
		'b218'=>'ExtentType',
		'b220'=>'ExtentUnit',
		'b219'=>'ExtentValue',
		'j271'=>'FaxNumber',
		'b286'=>'FirstPageNumber',
		'b033'=>'FormerTitle',
		'j265'=>'FreeQuantity',
		'm174'=>'FromCompany',
		'm172'=>'FromEANNumber',
		'm283'=>'FromEmail',
		'm175'=>'FromPerson',
		'm173'=>'FromSAN',
		'header'=>'Header',
		'c096'=>'Height',
		'b233'=>'IDTypeName',
		'b244'=>'IDValue',
		'b004'=>'ISBN',
		'b021'=>'ISBNOfSet',
		'b008'=>'ISMN',
		'b256'=>'IllustrationType',
		'b361'=>'IllustrationTypeDescription',
		'illustrations'=>'Illustrations',
		'b062'=>'IllustrationsNote',
		'f259'=>'ImageResolution',
		'imprint'=>'Imprint',
		'b079'=>'ImprintName',
		'k167'=>'InitialPrintRun',
		'b190'=>'InterestAge',
		'j348'=>'IntermediaryAvailabilityCode',
		'b026'=>'ItemNumberWithinSet',
		'b015'=>'ItemQuantity',
		'b040'=>'KeyNames',
		'language'=>'Language',
		'b252'=>'LanguageCode',
		'b059'=>'LanguageOfText',
		'b253'=>'LanguageRole',
		'j387'=>'LastDateForReturns',
		'b287'=>'LastPageNumber',
		'b042'=>'LettersAfterNames',
		'b284'=>'LevelSequenceNumber',
		'j377'=>'LocationIDType',
		'locationidentifier'=>'LocationIdentifier',
		'j349'=>'LocationName',
		'd101'=>'MainDescription',
		'mainseriesrecord'=>'MainSeriesRecord',
		'mainsubject'=>'MainSubject',
		'b191'=>'MainSubjectSchemeIdentifier',
		'b063'=>'MapScale',
		'j403'=>'MarketCountry',
		'j405'=>'MarketCountryExcluded',
		'marketdate'=>'MarketDate',
		'j408'=>'MarketDateRole',
		'j407'=>'MarketPublishingStatus',
		'marketrepresentation'=>'MarketRepresentation',
		'j406'=>'MarketRestrictionDetail',
		'j404'=>'MarketTerritory',
		'measure'=>'Measure',
		'c093'=>'MeasureTypeCode',
		'c095'=>'MeasureUnitCode',
		'c094'=>'Measurement',
		'mediafile'=>'MediaFile',
		'f373'=>'MediaFileDate',
		'f115'=>'MediaFileFormatCode',
		'f117'=>'MediaFileLink',
		'f116'=>'MediaFileLinkTypeCode',
		'f114'=>'MediaFileTypeCode',
		'm183'=>'MessageNote',
		'm180'=>'MessageNumber',
		'm181'=>'MessageRepeat',
		'j263'=>'MinimumOrderQuantity',
		'name'=>'Name',
		'b241'=>'NameCodeType',
		'b242'=>'NameCodeTypeName',
		'b243'=>'NameCodeValue',
		'b041'=>'NamesAfterKey',
		'b039'=>'NamesBeforeKey',
		'newsupplier'=>'NewSupplier',
		'n339'=>'NoContributor',
		'n386'=>'NoEdition',
		'n338'=>'NoSeries',
		'notforsale'=>'NotForSale',
		'a002'=>'NotificationType',
		'b257'=>'Number',
		'b125'=>'NumberOfIllustrations',
		'b061'=>'NumberOfPages',
		'b210'=>'NumberOfPieces',
		'b019'=>'NumberWithinSeries',
		'j350'=>'OnHand',
		'j351'=>'OnOrder',
		'onorderdetail'=>'OnOrderDetail',
		'j143'=>'OnSaleDate',
		'j144'=>'OrderTime',
		'b060'=>'OriginalLanguage',
		'b240'=>'OriginalPublisher',
		'othertext'=>'OtherText',
		'h134'=>'OutOfPrintDate',
		'j145'=>'PackQuantity',
		'pagerun'=>'PageRun',
		'b255'=>'PagesArabic',
		'b254'=>'PagesRoman',
		'parentidentifier'=>'ParentIdentifier',
		'b337'=>'Percent',
		'personassubject'=>'PersonAsSubject',
		'persondate'=>'PersonDate',
		'b305'=>'PersonDateRole',
		'b036'=>'PersonName',
		'b390'=>'PersonNameIDType',
		'personnameidentifier'=>'PersonNameIdentifier',
		'b037'=>'PersonNameInverted',
		'b250'=>'PersonNameType',
		'b072'=>'PlaceAsSubject',
		'b247'=>'PrefixToKey',
		'price'=>'Price',
		'j151'=>'PriceAmount',
		'j161'=>'PriceEffectiveFrom',
		'j162'=>'PriceEffectiveUntil',
		'j239'=>'PricePer',
		'j261'=>'PriceQualifier',
		'j266'=>'PriceStatus',
		'j148'=>'PriceTypeCode',
		'j262'=>'PriceTypeDescription',
		'prize'=>'Prize',
		'g129'=>'PrizeCode',
		'g128'=>'PrizeCountry',
		'g343'=>'PrizeJury',
		'g126'=>'PrizeName',
		'g127'=>'PrizeYear',
		'g124'=>'PrizesDescription',
		'product'=>'Product',
		'j396'=>'ProductAvailability',
		'productclassification'=>'ProductClassification',
		'b275'=>'ProductClassificationCode',
		'b274'=>'ProductClassificationType',
		'b385'=>'ProductContentType',
		'b012'=>'ProductForm',
		'b014'=>'ProductFormDescription',
		'b333'=>'ProductFormDetail',
		'productformfeature'=>'ProductFormFeature',
		'b336'=>'ProductFormFeatureDescription',
		'b334'=>'ProductFormFeatureType',
		'b335'=>'ProductFormFeatureValue',
		'b221'=>'ProductIDType',
		'productidentifier'=>'ProductIdentifier',
		'b225'=>'ProductPackaging',
		'productwebsite'=>'ProductWebsite',
		'f170'=>'ProductWebsiteDescription',
		'f123'=>'ProductWebsiteLink',
		'professionalaffiliation'=>'ProfessionalAffiliation',
		'b045'=>'ProfessionalPosition',
		'k165'=>'PromotionCampaign',
		'k166'=>'PromotionContact',
		'b003'=>'PublicationDate',
		'publisher'=>'Publisher',
		'b081'=>'PublisherName',
		'b007'=>'PublisherProductNo',
		'b017'=>'PublisherSeriesCode',
		'b291'=>'PublishingRole',
		'b394'=>'PublishingStatus',
		'b395'=>'PublishingStatusNote',
		'a001'=>'RecordReference',
		'a196'=>'RecordSourceIdentifier',
		'a195'=>'RecordSourceIdentifierType',
		'a197'=>'RecordSourceName',
		'a194'=>'RecordSourceType',
		'b398'=>'RegionCode',
		'reissue'=>'Reissue',
		'j365'=>'ReissueDate',
		'j366'=>'ReissueDescription',
		'relatedproduct'=>'RelatedProduct',
		'h208'=>'RelationCode',
		'religioustext'=>'ReligiousText',
		'religioustextfeature'=>'ReligiousTextFeature',
		'b359'=>'ReligiousTextFeatureCode',
		'b360'=>'ReligiousTextFeatureDescription',
		'b358'=>'ReligiousTextFeatureType',
		'b376'=>'ReligiousTextID',
		'h131'=>'ReplacedByEAN13',
		'h130'=>'ReplacedByISBN',
		'b011'=>'ReplacesEAN13',
		'b010'=>'ReplacesISBN',
		'k309'=>'ReprintDetail',
		'j269'=>'ReturnsCode',
		'j268'=>'ReturnsCodeType',
		'e110'=>'ReviewQuote',
		'b090'=>'RightsCountry',
		'b091'=>'RightsRegion',
		'b388'=>'RightsTerritory',
		'salesoutlet'=>'SalesOutlet',
		'b393'=>'SalesOutletIDType',
		'salesoutletidentifier'=>'SalesOutletIdentifier',
		'b382'=>'SalesOutletName',
		'salesrestriction'=>'SalesRestriction',
		'b383'=>'SalesRestrictionDetail',
		'b381'=>'SalesRestrictionType',
		'salesrights'=>'SalesRights',
		'b089'=>'SalesRightsType',
		'm379'=>'SenderIDType',
		'senderidentifier'=>'SenderIdentifier',
		'm182'=>'SentDate',
		'b034'=>'SequenceNumber',
		'b340'=>'SequenceNumberWithinRole',
		'series'=>'Series',
		'b273'=>'SeriesIDType',
		'b016'=>'SeriesISSN',
		'seriesidentifier'=>'SeriesIdentifier',
		'b282'=>'SeriesPartName',
		'set'=>'Set',
		'b281'=>'SetItemTitle',
		'b024'=>'SetPartNumber',
		'b025'=>'SetPartTitle',
		'b085'=>'SponsorName',
		'b324'=>'StartDate',
		'stock'=>'Stock',
		'j297'=>'StockQuantityCode',
		'j296'=>'StockQuantityCodeTypeName',
		'stockquantitycoded'=>'StockQuantityCoded',
		'b389'=>'StudyBibleType',
		'subseriesrecord'=>'SubSeriesRecord',
		'subject'=>'Subject',
		'b069'=>'SubjectCode',
		'b070'=>'SubjectHeadingText',
		'b067'=>'SubjectSchemeIdentifier',
		'b171'=>'SubjectSchemeName',
		'b068'=>'SubjectSchemeVersion',
		'a245'=>'SubordinateEntries',
		'b029'=>'Subtitle',
		'b248'=>'SuffixToKey',
		'j135'=>'SupplierEANLocationNumber',
		'j345'=>'SupplierIDType',
		'supplieridentifier'=>'SupplierIdentifier',
		'j137'=>'SupplierName',
		'j292'=>'SupplierRole',
		'j136'=>'SupplierSAN',
		'supplydetail'=>'SupplyDetail',
		'j399'=>'SupplyRestrictionDetail',
		'j138'=>'SupplyToCountry',
		'j140'=>'SupplyToCountryExcluded',
		'j139'=>'SupplyToRegion',
		'j397'=>'SupplyToTerritory',
		'j156'=>'TaxAmount1',
		'j160'=>'TaxAmount2',
		'j153'=>'TaxRateCode1',
		'j157'=>'TaxRateCode2',
		'j154'=>'TaxRatePercent1',
		'j158'=>'TaxRatePercent2',
		'j155'=>'TaxableAmount1',
		'j159'=>'TaxableAmount2',
		'j270'=>'TelephoneNumber',
		'j303'=>'Territory',
		'j308'=>'TerritoryExcluded',
		'd104'=>'Text',
		'd107'=>'TextAuthor',
		'b027'=>'TextCaseFlag',
		'd103'=>'TextFormat',
		'textitem'=>'TextItem',
		'b285'=>'TextItemIDType',
		'textitemidentifier'=>'TextItemIdentifier',
		'b290'=>'TextItemType',
		'd106'=>'TextLink',
		'd105'=>'TextLinkType',
		'd109'=>'TextPublicationDate',
		'b374'=>'TextSourceCorporate',
		'd108'=>'TextSourceTitle',
		'd102'=>'TextTypeCode',
		'f118'=>'TextWithDownload',
		'b369'=>'ThesisPresentedTo',
		'b368'=>'ThesisType',
		'b370'=>'ThesisYear',
		'c098'=>'Thickness',
		'title'=>'Title',
		'b018'=>'TitleOfSeries',
		'b023'=>'TitleOfSet',
		'b030'=>'TitlePrefix',
		'b203'=>'TitleText',
		'b202'=>'TitleType',
		'b031'=>'TitleWithoutPrefix',
		'b043'=>'TitlesAfterNames',
		'b038'=>'TitlesBeforeNames',
		'm178'=>'ToCompany',
		'm176'=>'ToEANNumber',
		'm179'=>'ToPerson',
		'm177'=>'ToSAN',
		'b362'=>'TradeAnnouncementDate',
		'b384'=>'TradeCategory',
		'b032'=>'TranslationOfTitle',
		'b006'=>'UPC',
		'b189'=>'USSchoolGrade',
		'b249'=>'UnnamedPersons',
		'j192'=>'UnpricedItemType',
		'website'=>'Website',
		'b294'=>'WebsiteDescription',
		'b295'=>'WebsiteLink',
		'b367'=>'WebsiteRole',
		'c099'=>'Weight',
		'c097'=>'Width',
		'b201'=>'WorkIDType',
		'workidentifier'=>'WorkIdentifier',
		'b088'=>'YearFirstPublished',
		'b020'=>'YearOfAnnual'
		);

	}
	
	public function loadXML($xml)
	{

		$this->xml = $xml;
		
	}
	
	public function getXSL()
	{
		if(!$this->xsl) {
			$xsl = '<?xml version="1.0" encoding="UTF-8" ?>';
			$xsl .= '<xsl:stylesheet xmlns:xhtml="http://www.w3.org/1999/xhtml" xmlns:xsl="http://www.w3.org/1999/XSL/Transform" version="1.0"><xsl:output method="xml" encoding="UTF-8" omit-xml-declaration="no" indent="no" />';
			$xsl .= '<xsl:template match="/"><xsl:apply-templates /></xsl:template>';
			foreach($this->productTagMap as $shortname=>$longname)
			{
				// match shortnames to long names
				$xsl .= '<xsl:template match="'.$shortname.'"><'.$longname.'><xsl:apply-templates/></'.$longname.'></xsl:template>';
				// match longnames too
				$xsl .= '<xsl:template match="'.$longname.'"><'.$longname.'><xsl:apply-templates/></'.$longname.'></xsl:template>';
			}
			$xsl .= '<xsl:template match="text()"><xsl:value-of select="."/></xsl:template></xsl:stylesheet>';	
	  	$this->xsl = $xsl;
		}
		return $this->xsl;
	}
	
	public function expandTags()
	{
		
	    $processor = new XSLTProcessor();
	    $xmlDom = new DOMDocument();
	    $xslDom = new DOMDocument();        
	    @$xmlDom->loadXML($this->xml);
	    @$xslDom->loadxml($this->getXSL());

	    $processor->importStylesheet($xslDom);

	    $t = $processor->transformToXML($xmlDom);
			$this->transformed = $t;
		
			return $this->transformed;
			
	}
	
	
	
	
}